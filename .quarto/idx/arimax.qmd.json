{"title":"ARIMAX/SARIMAX/VAR","markdown":{"yaml":{"title":"ARIMAX/SARIMAX/VAR"},"headingText":"The Variables","containsRefs":false,"markdown":"\n\n```{r, echo=FALSE,message=FALSE,warning=FALSE}\nlibrary(tidyverse)\nlibrary(ggplot2)\nlibrary(forecast)\nlibrary(astsa) \nlibrary(xts)\nlibrary(tseries)\nlibrary(fpp2)\nlibrary(fma)\nlibrary(lubridate)\nlibrary(tidyverse)\nlibrary(TSstudio)\nlibrary(quantmod)\nlibrary(tidyquant)\nlibrary(plotly)\nlibrary(ggplot2)\nlibrary(dplyr)\n```\n\nThis tab will focus on fitting ARIMAX/SARIMAX model or VAR/VARMA model to find the relationships between the time series variables.\n\nTherefore, this part mainly answers the question how the measures of wheat affect the price of wheat (dollars per bushel) in USA. These measures include the yield (tonnes per hectare), and the amount of food use (bushels). These variables record the situation of wheat production and usage, therefore will have impacts on the price of wheat in USA.\n\n\n\nFirst, read the data set, then make a plot of the time series predictors:\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\nwheat = read.csv(\"./HW4/USA_Wheat.csv\", sep=\",\")\nwheat = wheat[,c(1,3,4,5,6,7)]\nwheat$Yield = na.approx(wheat$Yield)\nwheat$Food_Use = as.numeric(gsub(\",\", \"\", wheat$Food_Use))\n# wheat$Import = as.numeric(gsub(\",\", \"\", wheat$Import))\n# wheat$Export = as.numeric(gsub(\",\", \"\", wheat$Export))\n\nstart_date = c(2002, 8)\nwheat_ts = ts(wheat, start=start_date, frequency=12)\n\nautoplot(wheat_ts[,c(3,2,4)], facets=TRUE)+\n  xlab(\"Time\")+ylab(\"\")+ggtitle(\"Time Series Plots of the Variables\")\n```\n\nIn order to put the data on a better scale, I will do a log transformation:\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\nlg.wheat = wheat\nlg.wheat$Price = log(wheat$Price)\nlg.wheat$Yield = log(wheat$Yield)\nlg.wheat$Food_Use = log(wheat$Food_Use)\n# lg.wheat$Import = log(wheat$Import)\n# lg.wheat$Export = log(wheat$Export)\n\nwheat_ts = ts(lg.wheat, start=start_date, frequency=12)\n\nautoplot(wheat_ts[,c(3,2,4)], facets=TRUE)+\n  xlab(\"Time\")+ylab(\"\")+ggtitle(\"Time Series Plots of the Variables\")\n```\n\nWe can see that the time series all have a increasing trend, while there is obvious seasonality for the amount of food use.\n\n#### \n\n### Fitting the Model Using \\`auto.arima\\`\n\nFirst, this function will be used to fit the ARIMAX model, and the exogenous (predictor) variables are Yield and Food_Use.\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\nxreg = cbind(yield = wheat_ts[,\"Yield\"],\n             food = wheat_ts[,\"Food_Use\"])\nfit_auto = auto.arima(wheat_ts[,\"Price\"], xreg=xreg)\nsummary(fit_auto)\ncheckresiduals(fit_auto)\n```\n\nFrom the summary, the \\`auto.arima\\` function creates a SARIMAX model, a regression model with ARIMA(0,1,2)(1,0,0)\\[12\\] errors. From the Ljung-Box test, the residuals should be independent according to a p-value larger than 0.05, and this means the model fits the time series well. From the Q-Q plot we can also see that basically the residuals form a normal distribution.\n\n#### \n\n### Fitting the Model Manually\n\nHaving the linear regression model predicting wheat price using yield and food use, for the residuals I will fit an ARIMA/SARIMA model.\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\ntsdf = lg.wheat[,c(1:4)]\ntsdf$Yield = ts(tsdf$Yield, start=start_date, frequency=12)\ntsdf$Food_Use = ts(tsdf$Food_Use, start=start_date, frequency=12)\ntsdf$Price = ts(tsdf$Price, start=start_date, frequency=12)\n\nfit_reg = lm(Price~Yield+Food_Use, data=tsdf)\n# summary(fit_reg)\nfit_res = ts(residuals(fit_reg), start=start_date, frequency=12)\n```\n\nLook at the residuals:\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\nacf(fit_res)\nPacf(fit_res)\n```\n\nLooks like the residuals is heavily auto correlated and not stationary. So I will first try with a normal differencing:\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\nfit_res %>% diff() %>% ggtsdisplay()\n```\n\nStill not good enough, therefore I will add a seasonal differencing:\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\nfit_res %>% diff() %>% diff(12) %>% ggtsdisplay()\n```\n\n#### \n\n### Finding the Model Parameters\n\nBased on the plots, I will choose a set of values for the parameters: d=D=1, p=\\[1,2,3\\], q=\\[1,2,3\\], P=\\[1,2\\], Q=\\[1,2\\].\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\nSARIMA.c = function(ps,qs,Ps,Qs,df){\n  scores = matrix(rep(NA, 9*36), nrow=36, ncol=9)\n  d=1\n  D=1\n  s=12\n  \n  i=1\n  for (p in ps){\n    for (q in qs){\n      for (P in Ps){\n        for (Q in Qs){\n          model = Arima(df, order=c(p-1,d,q-1), seasonal=c(P-1,D,Q-1))\n          scores[i,] = c(p-1,d,q-1,P-1,D,Q-1,model$aic,model$bic,model$aicc)\n          i=i+1\n        }\n      }\n    }\n  }\n  \n  scores = as.data.frame(scores)\n  colnames(scores) = c(\"p\",\"d\",\"q\",\"P\",\"D\",\"Q\",\"AIC\",\"BIC\",\"AICc\")\n  scores\n}\n\noutput = SARIMA.c(ps=c(1,2,3), qs=c(1,2,3), Ps=c(1,2), Qs=c(1,2), df=fit_res)\noutput\n```\n\nIt is obvious that the best model here is ARIMA(1,1,0)(0,1,1)\\[12\\], while \\`auto.arima\\` suggested ARIMA(0,1,2)(1,0,0)\\[12\\].\n\nLet's do some model diagnosis about this model.\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\nset.seed(140)\nmodel_output110 = capture.output(sarima(fit_res,1,1,0,0,1,1,12))\ncat(model_output110[23:52], model_output110[length(model_output110)], sep=\"\\n\")\n```\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\nmodel_output012 = capture.output(sarima(fit_res,0,1,2,1,0,0,12))\ncat(model_output012[20:50], model_output012[length(model_output110)], sep=\"\\n\")\n```\n\n#### \n\n### Use CV to Find the Best Model\n\nSince the two models above do not have much advantage over each other, in this step cross validation will be used to look for the optimal model, with RMSE plots.\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\nn = length(fit_res)\nk = 65\n\nrmse1 = rmse2 = matrix(NA,15,12)\nst = tsp(fit_res)[1]+(k-1)/12\n\nfor (i in 1:15){\n  xtrain = window(fit_res, end=st+i-1)\n  xtest = window(fit_res, start=st+i-1+1/12, end=st+i)\n  \n  fit1 = Arima(xtrain, order=c(1,1,0), seasonal=list(order=c(0,1,1),period=12), \n               include.drift=TRUE, method=\"ML\")\n  fcast1 = forecast(fit1, h=12)\n  \n  fit2 = Arima(xtrain, order=c(0,1,2), seasonal=list(order=c(1,0,0),period=12), \n               include.drift=TRUE, method=\"ML\")\n  fcast2 = forecast(fit2, h=12)\n  \n  rmse1[i,1:length(xtest)] = sqrt((fcast1$mean-xtest)^2)\n  rmse2[i,1:length(xtest)] = sqrt((fcast2$mean-xtest)^2)\n}\n\nplot(1:12, colMeans(rmse1, na.rm=TRUE), type=\"l\", col=2, xlab=\"Horizon\", ylab=\"RMSE\")\nlines(1:12, colMeans(rmse2, na.rm=TRUE), type=\"l\", col=3)\nlegend(\"topleft\", legend=c(\"my fit\", \"auto fit\"), col=2:3, lty=1)\n```\n\nBased on the result of the cross validation, my optimal fit ARIMA(1,1,0)(0,1,1)\\[12\\] is better since it has lower RMSE.\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\nxreg = cbind(yield = tsdf[,\"Yield\"],\n             food = tsdf[,\"Food_Use\"])\nfit = Arima(tsdf[,\"Price\"], order=c(1,1,0), seasonal=c(0,1,1), xreg=xreg)\nsummary(fit)\n```\n\nFrom the summary of the fit, it can be determined that the equation of the model is:\n\n$$\ny_t = −0.2964x_{1,t}+0.0762x_{2,t}+u_t \\\\\nu_t = (1+0.3606B)(1−B^4)ε_t.\n$$\n\n#### \n\n### Forecasting\n\nIn order to forecast the price of wheat, I need to have forecasts of yield and the food use first. Then the obtained forecasts will be used to find the prediction of the price.\n\n```{r, echo=TRUE,message=FALSE,warning=FALSE}\nfit_yield = Arima(tsdf$Yield, order=c(1,1,0), seasonal=list(order=c(0,1,1),period=12))\nfyield = forecast(fit_yield, h=24)\nfit_food = Arima(tsdf$Food_Use, order=c(1,1,0), seasonal=list(order=c(0,1,1),period=12))\nffood = forecast(fit_food, h=24)\n\nfxreg = cbind(Yield=fyield$mean, Food=ffood$mean)\n\nfcast = forecast(fit, xreg=fxreg)\n\nautoplot(fcast)+xlab(\"Time\")+ylab(\"Price\")\n```\n\nFrom the forecast plot, it seems that the prediction of the wheat price for the next two years follows the trend of the original time series, with a large confidence band. It seems that the result is not very nice.\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"output-file":"arimax.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.335","editor":"visual","theme":"flatly","title":"ARIMAX/SARIMAX/VAR"},"extensions":{"book":{"multiFile":true}}}}}