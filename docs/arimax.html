<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Time Series Project - Haiyu Xiao - ARIMAX/SARIMAX/VAR</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Time Series Project - Haiyu Xiao</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html">
 <span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./introduction.html">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./data_sources.html">
 <span class="menu-text">Data Sources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./data_visualization.html">
 <span class="menu-text">Data Visualization</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./eda.html">
 <span class="menu-text">Exploratory Data Analysis</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-models" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Models</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-models">    
        <li>
    <a class="dropdown-item" href="./arma.html">
 <span class="dropdown-text">ARMA/ARIMA/SARIMA Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./arimax.html">
 <span class="dropdown-text">ARIMAX/SARIMAX/VAR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./financial.html">
 <span class="dropdown-text">Financial Time Series Models (ARCH/GARCH)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./deep_learning.html">
 <span class="dropdown-text">Deep Learning for TS</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./conclusions.html">
 <span class="menu-text">Conclusions</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-variables" id="toc-the-variables" class="nav-link active" data-scroll-target="#the-variables">The Variables</a></li>
  <li><a href="#fitting-the-model-using-auto.arima" id="toc-fitting-the-model-using-auto.arima" class="nav-link" data-scroll-target="#fitting-the-model-using-auto.arima">Fitting the Model Using `auto.arima`</a></li>
  <li><a href="#fitting-the-model-manually" id="toc-fitting-the-model-manually" class="nav-link" data-scroll-target="#fitting-the-model-manually">Fitting the Model Manually</a></li>
  <li><a href="#finding-the-model-parameters" id="toc-finding-the-model-parameters" class="nav-link" data-scroll-target="#finding-the-model-parameters">Finding the Model Parameters</a></li>
  <li><a href="#use-cv-to-find-the-best-model" id="toc-use-cv-to-find-the-best-model" class="nav-link" data-scroll-target="#use-cv-to-find-the-best-model">Use CV to Find the Best Model</a></li>
  <li><a href="#forecasting" id="toc-forecasting" class="nav-link" data-scroll-target="#forecasting">Forecasting</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ARIMAX/SARIMAX/VAR</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="cell">

</div>
<p>This tab will focus on fitting ARIMAX/SARIMAX model or VAR/VARMA model to find the relationships between the time series variables.</p>
<p>Therefore, this part mainly answers the question how the measures of wheat affect the price of wheat (dollars per bushel) in USA. These measures include the yield (tonnes per hectare), and the amount of food use (bushels). These variables record the situation of wheat production and usage, therefore will have impacts on the price of wheat in USA.</p>
<section id="section" class="level4">
<h4 class="anchored" data-anchor-id="section"></h4>
</section>
<section id="the-variables" class="level3">
<h3 class="anchored" data-anchor-id="the-variables">The Variables</h3>
<p>First, read the data set, then make a plot of the time series predictors:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>wheat <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"./HW4/USA_Wheat.csv"</span>, <span class="at">sep=</span><span class="st">","</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>wheat <span class="ot">=</span> wheat[,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>)]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>wheat<span class="sc">$</span>Yield <span class="ot">=</span> <span class="fu">na.approx</span>(wheat<span class="sc">$</span>Yield)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>wheat<span class="sc">$</span>Food_Use <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">","</span>, <span class="st">""</span>, wheat<span class="sc">$</span>Food_Use))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># wheat$Import = as.numeric(gsub(",", "", wheat$Import))</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># wheat$Export = as.numeric(gsub(",", "", wheat$Export))</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">2002</span>, <span class="dv">8</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>wheat_ts <span class="ot">=</span> <span class="fu">ts</span>(wheat, <span class="at">start=</span>start_date, <span class="at">frequency=</span><span class="dv">12</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(wheat_ts[,<span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">4</span>)], <span class="at">facets=</span><span class="cn">TRUE</span>)<span class="sc">+</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time"</span>)<span class="sc">+</span><span class="fu">ylab</span>(<span class="st">""</span>)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Time Series Plots of the Variables"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="arimax_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In order to put the data on a better scale, I will do a log transformation:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>lg.wheat <span class="ot">=</span> wheat</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>lg.wheat<span class="sc">$</span>Price <span class="ot">=</span> <span class="fu">log</span>(wheat<span class="sc">$</span>Price)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>lg.wheat<span class="sc">$</span>Yield <span class="ot">=</span> <span class="fu">log</span>(wheat<span class="sc">$</span>Yield)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>lg.wheat<span class="sc">$</span>Food_Use <span class="ot">=</span> <span class="fu">log</span>(wheat<span class="sc">$</span>Food_Use)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># lg.wheat$Import = log(wheat$Import)</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># lg.wheat$Export = log(wheat$Export)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>wheat_ts <span class="ot">=</span> <span class="fu">ts</span>(lg.wheat, <span class="at">start=</span>start_date, <span class="at">frequency=</span><span class="dv">12</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(wheat_ts[,<span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">4</span>)], <span class="at">facets=</span><span class="cn">TRUE</span>)<span class="sc">+</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time"</span>)<span class="sc">+</span><span class="fu">ylab</span>(<span class="st">""</span>)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Time Series Plots of the Variables"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="arimax_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that the time series all have a increasing trend, while there is obvious seasonality for the amount of food use.</p>
<section id="section-1" class="level4">
<h4 class="anchored" data-anchor-id="section-1"></h4>
</section>
</section>
<section id="fitting-the-model-using-auto.arima" class="level3">
<h3 class="anchored" data-anchor-id="fitting-the-model-using-auto.arima">Fitting the Model Using `auto.arima`</h3>
<p>First, this function will be used to fit the ARIMAX model, and the exogenous (predictor) variables are Yield and Food_Use.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>xreg <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">yield =</span> wheat_ts[,<span class="st">"Yield"</span>],</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">food =</span> wheat_ts[,<span class="st">"Food_Use"</span>])</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>fit_auto <span class="ot">=</span> <span class="fu">auto.arima</span>(wheat_ts[,<span class="st">"Price"</span>], <span class="at">xreg=</span>xreg)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_auto)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Series: wheat_ts[, "Price"] 
Regression with ARIMA(0,1,2)(1,0,0)[12] errors 

Coefficients:
         ma1     ma2     sar1    yield    food
      0.4264  0.0807  -0.0103  -0.3092  0.1463
s.e.  0.0665  0.0655   0.0684   0.1520  0.0551

sigma^2 = 0.002313:  log likelihood = 396.68
AIC=-781.36   AICc=-781   BIC=-760.37

Training set error measures:
                      ME       RMSE        MAE       MPE     MAPE      MASE
Training set 0.002698144 0.04749694 0.03430143 0.1413272 2.063324 0.1604087
                    ACF1
Training set -0.01739135</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">checkresiduals</span>(fit_auto)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="arimax_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(0,1,2)(1,0,0)[12] errors
Q* = 13.793, df = 21, p-value = 0.8783

Model df: 3.   Total lags used: 24</code></pre>
</div>
</div>
<p>From the summary, the `auto.arima` function creates a SARIMAX model, a regression model with ARIMA(0,1,2)(1,0,0)[12] errors. From the Ljung-Box test, the residuals should be independent according to a p-value larger than 0.05, and this means the model fits the time series well. From the Q-Q plot we can also see that basically the residuals form a normal distribution.</p>
<section id="section-2" class="level4">
<h4 class="anchored" data-anchor-id="section-2"></h4>
</section>
</section>
<section id="fitting-the-model-manually" class="level3">
<h3 class="anchored" data-anchor-id="fitting-the-model-manually">Fitting the Model Manually</h3>
<p>Having the linear regression model predicting wheat price using yield and food use, for the residuals I will fit an ARIMA/SARIMA model.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>tsdf <span class="ot">=</span> lg.wheat[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>tsdf<span class="sc">$</span>Yield <span class="ot">=</span> <span class="fu">ts</span>(tsdf<span class="sc">$</span>Yield, <span class="at">start=</span>start_date, <span class="at">frequency=</span><span class="dv">12</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>tsdf<span class="sc">$</span>Food_Use <span class="ot">=</span> <span class="fu">ts</span>(tsdf<span class="sc">$</span>Food_Use, <span class="at">start=</span>start_date, <span class="at">frequency=</span><span class="dv">12</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>tsdf<span class="sc">$</span>Price <span class="ot">=</span> <span class="fu">ts</span>(tsdf<span class="sc">$</span>Price, <span class="at">start=</span>start_date, <span class="at">frequency=</span><span class="dv">12</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>fit_reg <span class="ot">=</span> <span class="fu">lm</span>(Price<span class="sc">~</span>Yield<span class="sc">+</span>Food_Use, <span class="at">data=</span>tsdf)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(fit_reg)</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>fit_res <span class="ot">=</span> <span class="fu">ts</span>(<span class="fu">residuals</span>(fit_reg), <span class="at">start=</span>start_date, <span class="at">frequency=</span><span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Look at the residuals:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(fit_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="arimax_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Pacf</span>(fit_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="arimax_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Looks like the residuals is heavily auto correlated and not stationary. So I will first try with a normal differencing:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fit_res <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">ggtsdisplay</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="arimax_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Still not good enough, therefore I will add a seasonal differencing:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>fit_res <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">diff</span>(<span class="dv">12</span>) <span class="sc">%&gt;%</span> <span class="fu">ggtsdisplay</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="arimax_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="section-3" class="level4">
<h4 class="anchored" data-anchor-id="section-3"></h4>
</section>
</section>
<section id="finding-the-model-parameters" class="level3">
<h3 class="anchored" data-anchor-id="finding-the-model-parameters">Finding the Model Parameters</h3>
<p>Based on the plots, I will choose a set of values for the parameters: d=D=1, p=[1,2,3], q=[1,2,3], P=[1,2], Q=[1,2].</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>SARIMA.c <span class="ot">=</span> <span class="cf">function</span>(ps,qs,Ps,Qs,df){</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  scores <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">9</span><span class="sc">*</span><span class="dv">36</span>), <span class="at">nrow=</span><span class="dv">36</span>, <span class="at">ncol=</span><span class="dv">9</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  d<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  D<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  s<span class="ot">=</span><span class="dv">12</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  i<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (p <span class="cf">in</span> ps){</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (q <span class="cf">in</span> qs){</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (P <span class="cf">in</span> Ps){</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (Q <span class="cf">in</span> Qs){</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>          model <span class="ot">=</span> <span class="fu">Arima</span>(df, <span class="at">order=</span><span class="fu">c</span>(p<span class="dv">-1</span>,d,q<span class="dv">-1</span>), <span class="at">seasonal=</span><span class="fu">c</span>(P<span class="dv">-1</span>,D,Q<span class="dv">-1</span>))</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>          scores[i,] <span class="ot">=</span> <span class="fu">c</span>(p<span class="dv">-1</span>,d,q<span class="dv">-1</span>,P<span class="dv">-1</span>,D,Q<span class="dv">-1</span>,model<span class="sc">$</span>aic,model<span class="sc">$</span>bic,model<span class="sc">$</span>aicc)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>          i<span class="ot">=</span>i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  scores <span class="ot">=</span> <span class="fu">as.data.frame</span>(scores)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(scores) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"p"</span>,<span class="st">"d"</span>,<span class="st">"q"</span>,<span class="st">"P"</span>,<span class="st">"D"</span>,<span class="st">"Q"</span>,<span class="st">"AIC"</span>,<span class="st">"BIC"</span>,<span class="st">"AICc"</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  scores</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>output <span class="ot">=</span> <span class="fu">SARIMA.c</span>(<span class="at">ps=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">qs=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">Ps=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">Qs=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">df=</span>fit_res)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   p d q P D Q       AIC       BIC      AICc
1  0 1 0 0 1 0 -506.7858 -503.3391 -506.7684
2  0 1 0 0 1 1 -643.4813 -636.5878 -643.4289
3  0 1 0 1 1 0 -575.2285 -568.3351 -575.1761
4  0 1 0 1 1 1 -643.7872 -633.4470 -643.6820
5  0 1 1 0 1 0 -534.3747 -527.4812 -534.3223
6  0 1 1 0 1 1 -662.7142 -652.3740 -662.6089
7  0 1 1 1 1 0 -597.5658 -587.2256 -597.4606
8  0 1 1 1 1 1 -662.1226 -648.3357 -661.9464
9  0 1 2 0 1 0 -534.0560 -523.7158 -533.9508
10 0 1 2 0 1 1 -663.3070 -649.5200 -663.1307
11 0 1 2 1 1 0 -598.8966 -585.1096 -598.7204
12 0 1 2 1 1 1 -662.9045 -645.6709 -662.6391
13 1 1 0 0 1 0 -533.3746 -526.4811 -533.3222
14 1 1 0 0 1 1 -663.8113 -653.4711 -663.7060
15 1 1 0 1 1 0 -599.6166 -589.2764 -599.5113
16 1 1 0 1 1 1 -663.3964 -649.6095 -663.2202
17 1 1 1 0 1 0 -533.4232 -523.0830 -533.3179
18 1 1 1 0 1 1 -662.1953 -648.4084 -662.0191
19 1 1 1 1 1 0 -597.8183 -584.0314 -597.6421
20 1 1 1 1 1 1 -661.6768 -644.4432 -661.4114
21 1 1 2 0 1 0 -533.9757 -520.1888 -533.7995
22 1 1 2 0 1 1 -663.2445 -646.0108 -662.9790
23 1 1 2 1 1 0 -598.1932 -580.9596 -597.9278
24 1 1 2 1 1 1 -662.9587 -642.2783 -662.5854
25 2 1 0 0 1 0 -534.1136 -523.7734 -534.0083
26 2 1 0 0 1 1 -662.3847 -648.5977 -662.2085
27 2 1 0 1 1 0 -597.8694 -584.0824 -597.6932
28 2 1 0 1 1 1 -661.8222 -644.5885 -661.5567
29 2 1 1 0 1 0 -532.1390 -518.3521 -531.9628
30 2 1 1 0 1 1 -660.2318 -642.9981 -659.9663
31 2 1 1 1 1 0 -595.8844 -578.6507 -595.6189
32 2 1 1 1 1 1 -659.9228 -639.2424 -659.5495
33 2 1 2 0 1 0 -532.7373 -515.5036 -532.4718
34 2 1 2 0 1 1 -662.2417 -641.5613 -661.8684
35 2 1 2 1 1 0 -596.4577 -575.7773 -596.0843
36 2 1 2 1 1 1 -662.0553 -637.9282 -661.5553</code></pre>
</div>
</div>
<p>It is obvious that the best model here is ARIMA(1,1,0)(0,1,1)[12], while `auto.arima` suggested ARIMA(0,1,2)(1,0,0)[12].</p>
<p>Let’s do some model diagnosis about this model.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">140</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>model_output110 <span class="ot">=</span> <span class="fu">capture.output</span>(<span class="fu">sarima</span>(fit_res,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="arimax_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(model_output110[<span class="dv">23</span><span class="sc">:</span><span class="dv">52</span>], model_output110[<span class="fu">length</span>(model_output110)], <span class="at">sep=</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>converged
$fit

Call:
arima(x = xdata, order = c(p, d, q), seasonal = list(order = c(P, D, Q), period = S), 
    include.mean = !no.constant, transform.pars = trans, fixed = fixed, optim.control = list(trace = trc, 
        REPORT = 1, reltol = tol))

Coefficients:
         ar1     sma1
      0.3072  -1.0000
s.e.  0.0634   0.1139

sigma^2 estimated as 0.002791:  log likelihood = 334.91,  aic = -663.81

$degrees_of_freedom
[1] 230

$ttable
     Estimate     SE t.value p.value
ar1    0.3072 0.0634  4.8457       0
sma1  -1.0000 0.1139 -8.7783       0

$AIC
[1] -2.861256

$AICc
[1] -2.86103

$BIC</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>model_output012 <span class="ot">=</span> <span class="fu">capture.output</span>(<span class="fu">sarima</span>(fit_res,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="arimax_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(model_output012[<span class="dv">20</span><span class="sc">:</span><span class="dv">50</span>], model_output012[<span class="fu">length</span>(model_output110)], <span class="at">sep=</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>iter   5 value -2.675943
iter   6 value -2.675944
iter   7 value -2.675945
iter   8 value -2.675946
iter   9 value -2.675947
iter  10 value -2.675947
iter  10 value -2.675947
final  value -2.675947 
converged
$fit

Call:
arima(x = xdata, order = c(p, d, q), seasonal = list(order = c(P, D, Q), period = S), 
    xreg = constant, transform.pars = trans, fixed = fixed, optim.control = list(trace = trc, 
        REPORT = 1, reltol = tol))

Coefficients:
         ma1     ma2    sar1  constant
      0.2726  0.1086  0.5898    0.0038
s.e.  0.0713  0.0729  0.0583    0.0137

sigma^2 estimated as 0.004639:  log likelihood = 306.71,  aic = -603.42

$degrees_of_freedom
[1] 240

$ttable
         Estimate     SE t.value p.value
ma1        0.2726 0.0713  3.8225  0.0002
ma2        0.1086 0.0729  1.4896  0.1377
sar1       0.5898 0.0583 10.1240  0.0000
[1] -2.473033</code></pre>
</div>
</div>
<section id="section-4" class="level4">
<h4 class="anchored" data-anchor-id="section-4"></h4>
</section>
</section>
<section id="use-cv-to-find-the-best-model" class="level3">
<h3 class="anchored" data-anchor-id="use-cv-to-find-the-best-model">Use CV to Find the Best Model</h3>
<p>Since the two models above do not have much advantage over each other, in this step cross validation will be used to look for the optimal model, with RMSE plots.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">length</span>(fit_res)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>k <span class="ot">=</span> <span class="dv">65</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>rmse1 <span class="ot">=</span> rmse2 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">15</span>,<span class="dv">12</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>st <span class="ot">=</span> <span class="fu">tsp</span>(fit_res)[<span class="dv">1</span>]<span class="sc">+</span>(k<span class="dv">-1</span>)<span class="sc">/</span><span class="dv">12</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>){</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  xtrain <span class="ot">=</span> <span class="fu">window</span>(fit_res, <span class="at">end=</span>st<span class="sc">+</span>i<span class="dv">-1</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  xtest <span class="ot">=</span> <span class="fu">window</span>(fit_res, <span class="at">start=</span>st<span class="sc">+</span>i<span class="dv">-1</span><span class="sc">+</span><span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>, <span class="at">end=</span>st<span class="sc">+</span>i)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  fit1 <span class="ot">=</span> <span class="fu">Arima</span>(xtrain, <span class="at">order=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), <span class="at">seasonal=</span><span class="fu">list</span>(<span class="at">order=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="at">period=</span><span class="dv">12</span>), </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.drift=</span><span class="cn">TRUE</span>, <span class="at">method=</span><span class="st">"ML"</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  fcast1 <span class="ot">=</span> <span class="fu">forecast</span>(fit1, <span class="at">h=</span><span class="dv">12</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  fit2 <span class="ot">=</span> <span class="fu">Arima</span>(xtrain, <span class="at">order=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">seasonal=</span><span class="fu">list</span>(<span class="at">order=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="at">period=</span><span class="dv">12</span>), </span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.drift=</span><span class="cn">TRUE</span>, <span class="at">method=</span><span class="st">"ML"</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  fcast2 <span class="ot">=</span> <span class="fu">forecast</span>(fit2, <span class="at">h=</span><span class="dv">12</span>)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  rmse1[i,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(xtest)] <span class="ot">=</span> <span class="fu">sqrt</span>((fcast1<span class="sc">$</span>mean<span class="sc">-</span>xtest)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  rmse2[i,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(xtest)] <span class="ot">=</span> <span class="fu">sqrt</span>((fcast2<span class="sc">$</span>mean<span class="sc">-</span>xtest)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="fu">colMeans</span>(rmse1, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="at">type=</span><span class="st">"l"</span>, <span class="at">col=</span><span class="dv">2</span>, <span class="at">xlab=</span><span class="st">"Horizon"</span>, <span class="at">ylab=</span><span class="st">"RMSE"</span>)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="fu">colMeans</span>(rmse2, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="at">type=</span><span class="st">"l"</span>, <span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"my fit"</span>, <span class="st">"auto fit"</span>), <span class="at">col=</span><span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">lty=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="arimax_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Based on the result of the cross validation, my optimal fit ARIMA(1,1,0)(0,1,1)[12] is better since it has lower RMSE.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>xreg <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">yield =</span> tsdf[,<span class="st">"Yield"</span>],</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">food =</span> tsdf[,<span class="st">"Food_Use"</span>])</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">=</span> <span class="fu">Arima</span>(tsdf[,<span class="st">"Price"</span>], <span class="at">order=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), <span class="at">seasonal=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">xreg=</span>xreg)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Series: tsdf[, "Price"] 
Regression with ARIMA(1,1,0)(0,1,1)[12] errors 

Coefficients:
         ar1     sma1    yield    food
      0.3606  -1.0000  -0.2964  0.0762
s.e.  0.0630   0.0782   0.1519  0.2169

sigma^2 = 0.002217:  log likelihood = 363.64
AIC=-717.29   AICc=-717.02   BIC=-700.05

Training set error measures:
                        ME       RMSE        MAE         MPE     MAPE      MASE
Training set -7.128984e-05 0.04541963 0.03282718 -0.01445618 1.957385 0.1535144
                   ACF1
Training set 0.04637381</code></pre>
</div>
</div>
<p>From the summary of the fit, it can be determined that the equation of the model is:</p>
<p><span class="math display">\[
y_t = −0.2964x_{1,t}+0.0762x_{2,t}+u_t \\
u_t = (1+0.3606B)(1−B^4)ε_t.
\]</span></p>
<section id="section-5" class="level4">
<h4 class="anchored" data-anchor-id="section-5"></h4>
</section>
</section>
<section id="forecasting" class="level3">
<h3 class="anchored" data-anchor-id="forecasting">Forecasting</h3>
<p>In order to forecast the price of wheat, I need to have forecasts of yield and the food use first. Then the obtained forecasts will be used to find the prediction of the price.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>fit_yield <span class="ot">=</span> <span class="fu">Arima</span>(tsdf<span class="sc">$</span>Yield, <span class="at">order=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), <span class="at">seasonal=</span><span class="fu">list</span>(<span class="at">order=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="at">period=</span><span class="dv">12</span>))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>fyield <span class="ot">=</span> <span class="fu">forecast</span>(fit_yield, <span class="at">h=</span><span class="dv">24</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>fit_food <span class="ot">=</span> <span class="fu">Arima</span>(tsdf<span class="sc">$</span>Food_Use, <span class="at">order=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), <span class="at">seasonal=</span><span class="fu">list</span>(<span class="at">order=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="at">period=</span><span class="dv">12</span>))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>ffood <span class="ot">=</span> <span class="fu">forecast</span>(fit_food, <span class="at">h=</span><span class="dv">24</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>fxreg <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">Yield=</span>fyield<span class="sc">$</span>mean, <span class="at">Food=</span>ffood<span class="sc">$</span>mean)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>fcast <span class="ot">=</span> <span class="fu">forecast</span>(fit, <span class="at">xreg=</span>fxreg)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(fcast)<span class="sc">+</span><span class="fu">xlab</span>(<span class="st">"Time"</span>)<span class="sc">+</span><span class="fu">ylab</span>(<span class="st">"Price"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="arimax_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>From the forecast plot, it seems that the prediction of the wheat price for the next two years follows the trend of the original time series, with a large confidence band. It seems that the result is not very nice.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>